<!DOCTYPE html>
<html>
<head>
    <title>{{ story_title }}</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
            background-color: #1b1919;
            position: relative;
            transition: background-color 0.5s ease;
        }

        h1 {
            color: #adadad;
            transition: color 0.5s ease;
        }

        .content {
            white-space: pre-wrap;
            text-align: left;
            background-color: #333;
            padding: 20px;
            border-radius: 5px;
            font-size: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            color: #fff;
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        .buttons {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            font-size: 20px;
            flex-wrap: wrap;
        }

        .buttons a,
        .buttons button {
            margin: 5px;
            padding: 10px 20px;
            font-size: 20px;
            border: none;
            border-radius: 5px;
            color: #fff;
            cursor: pointer;
            transition: background-color 0.5s ease;
            text-decoration: none;
            background-color: {{ button_color }};
        }

        .history {
            margin-top: 20px;
            text-align: left;
            color: #adadad;
            background-color: #1b1919;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        .history-item {
            margin-bottom: 5px;
        }

        #dice-animation-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            width: 200px;
            height: 200px;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .mode-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
        }

        .mode-toggle label {
            display: flex;
            align-items: center;
            margin-left: 10px;
            cursor: pointer;
        }

        .mode-toggle-text {
            margin-left: 5px;
            color: #adadad;
            transition: color 0.5s ease;
        }

        body.light-mode {
            background-color: #fff;
        }

        body.light-mode h1 {
            color: #333;
        }

        body.light-mode .content {
            background-color: #fff;
            color: #333;
        }

        body.light-mode .history {
            background-color: #f5f5f5;
            color: #333;
        }

        body.light-mode .mode-toggle-text {
            color: #333;
        }

        @font-face {
            font-family: 'OpenDyslexic';
            src: url('/fonts/OpenDyslexic3-Regular.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'OpenDyslexic';
            src: url('/fonts/OpenDyslexic3-Bold.ttf') format('truetype');
            font-weight: bold;
            font-style: normal;
        }

        body.dyslexic-font {
            font-family: 'OpenDyslexic', Arial, sans-serif;
        }

        body.dyslexic-font .content,
        body.dyslexic-font .buttons button,
        body.dyslexic-font .history,
        body.dyslexic-font #roll-button,
        body.dyslexic-font .mode-toggle-text {
            font-family: 'OpenDyslexic', Arial, sans-serif;
        }

        .main-menu-button {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background-color: #555;
            color: #fff;
            text-decoration: none;
            border-radius: 5px;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        .main-menu-button:hover {
            background-color: #777;
        }
    </style>
</head>
<body>
    <a href="{{ url_for('main_menu') }}" class="main-menu-button">Return to Main Menu</a>

    <div class="mode-toggle">
        <label>
            <input type="checkbox" id="mode-toggle-checkbox">
            <span class="mode-toggle-text">Light Mode</span>
        </label>
        <label>
            <input type="checkbox" id="dyslexic-toggle-checkbox">
            <span class="mode-toggle-text">Dyslexic Font</span>
        </label>
    </div>

    <h1>{{ story_title }}</h1>
    <div class="content">
        {% set paragraphs = content.split('\n\n') %}
        {% for paragraph in paragraphs %}
            <p>{{ paragraph }}</p>
        {% endfor %}
    </div>

    <div class="buttons">
        {% for direction, room_data in exits %}
            {% if room_data is mapping and 'skill_check' in room_data %}
                <form method="post" action="{{ url_for('adventure_game') }}">
                    <input type="hidden" name="direction" value="{{ direction }}">
                    <button type="submit" style="background-color: {{ button_color }};">{{ direction.capitalize().replace('_', ' ') }}</button>
                    <p>Skill Check: {{ room_data.skill_check.dice_type }} >= {{ room_data.skill_check.target }}</p>
                </form>
            {% else %}
                <form method="post" action="{{ url_for('adventure_game') }}">
                    <input type="hidden" name="direction" value="{{ direction }}">
                    <button type="submit" style="background-color: {{ button_color }};">{{ direction.capitalize().replace('_', ' ') }}</button>
                </form>
            {% endif %}
        {% endfor %}
    </div>

    <form id="adventure-form" method="post">
        <!-- Hidden inputs to maintain state -->
        <input type="hidden" name="current_room" value="{{ room.name }}">
        <input type="hidden" name="action_history" value="{{ action_history|join(',') }}">
    </form>

    {% if show_map %}
    <div>
        <img src="{{ url_for('serve_image', filename=room.image) }}" alt="Room Image">
    </div>
    {% endif %}

    <div id="dice-animation-container">
        {% if animation_html %}
            {{ animation_html|safe }}
        {% endif %}
    </div>

    <div class="history">
        <h2>Action History:</h2>
        {% for item in action_history %}
            <div class="history-item">{{ item.replace('_', ' ')|capitalize }}</div>
        {% endfor %}
    </div>

    <script>
        const form = document.getElementById('adventure-form');
        const buttons = document.querySelectorAll('.buttons button');

        buttons.forEach(button => {
            button.addEventListener('click', () => {
                const directionInput = document.createElement('input');
                directionInput.type = 'hidden';
                directionInput.name = 'direction';
                directionInput.value = button.value;
                form.appendChild(directionInput);
                form.submit();
            });
        });

        const modeToggleCheckbox = document.getElementById('mode-toggle-checkbox');
        const dyslexicToggleCheckbox = document.getElementById('dyslexic-toggle-checkbox');

        // Load the light mode setting from localStorage
        const isLightModeEnabled = localStorage.getItem('isLightModeEnabled') === 'true';
        modeToggleCheckbox.checked = isLightModeEnabled;
        updateMode(isLightModeEnabled);

        modeToggleCheckbox.addEventListener('change', () => {
            updateMode(modeToggleCheckbox.checked);

            // Store the light mode setting in localStorage
            localStorage.setItem('isLightModeEnabled', modeToggleCheckbox.checked);
        });

        function updateMode(isLightMode) {
            const body = document.body;
            const modeToggleText = modeToggleCheckbox.nextElementSibling;
            const elements = document.querySelectorAll('.content, h1, .history, .mode-toggle-text');

            modeToggleText.textContent = isLightMode ? 'Dark Mode' : 'Light Mode';

            if (isLightMode) {
                body.classList.add('light-mode');
                elements.forEach(element => {
                    element.classList.add('light-mode');
                });
            } else {
                body.classList.remove('light-mode');
                elements.forEach(element => {
                    element.classList.remove('light-mode');
                });
            }
        }

        // Load the dyslexic font setting from localStorage
        const isDyslexicFontEnabled = localStorage.getItem('isDyslexicFontEnabled') === 'true';
        dyslexicToggleCheckbox.checked = isDyslexicFontEnabled;
        document.body.classList.toggle('dyslexic-font', isDyslexicFontEnabled);

        dyslexicToggleCheckbox.addEventListener('change', () => {
            document.body.classList.toggle('dyslexic-font');

            // Store the dyslexic font setting in localStorage
            localStorage.setItem('isDyslexicFontEnabled', dyslexicToggleCheckbox.checked);
        });
    </script>
</body>
</html>